# 評価指標

## 目次
1. [評価指標とは](#評価指標とは)
2. [回帰の評価指標](#回帰の評価指標)
3. [決定係数（R²）](#決定係数r²)
4. [調整済み決定係数](#調整済み決定係数)
5. [指標の使い分け](#指標の使い分け)
6. [実装の比較](#実装の比較)
7. [まとめ](#まとめ)

## 評価指標とは

### 定義
評価指標（Evaluation Metrics）は、**機械学習モデルの性能を定量的に測定する指標**です。適切な指標の選択により、モデルの品質を客観的に評価できます。

### 評価指標の重要性

1. **モデル比較**: 複数のモデルの性能を比較
2. **改善の方向性**: どの部分を改善すべきかを特定
3. **ビジネス価値**: 実用的な価値を定量化
4. **意思決定**: モデルの採用・改善の判断

### 評価指標の分類

#### 1. 問題の種類による分類
- **回帰**: 連続値を予測
- **分類**: カテゴリを予測
- **クラスタリング**: グループ分け
- **推薦**: アイテムの推薦

#### 2. 指標の性質による分類
- **絶対指標**: 絶対的な性能
- **相対指標**: ベースラインとの比較
- **ランキング指標**: 順序の正確性

## 回帰の評価指標

### 基本概念

回帰問題では、**実際の値と予測値の差**を測定します。

### 主要な評価指標

#### 1. 平均二乗誤差（MSE: Mean Squared Error）

**定義**:
```
MSE = (1/n) × Σ(yᵢ - ŷᵢ)²
```

**特徴**:
- 誤差の二乗を平均
- 大きな誤差を重視
- 単位は目的変数の二乗

**解釈**:
- 小さいほど良い
- 0が最良
- 外れ値に敏感

#### 2. 平均平方根誤差（RMSE: Root Mean Squared Error）

**定義**:
```
RMSE = √MSE = √[(1/n) × Σ(yᵢ - ŷᵢ)²]
```

**特徴**:
- MSEの平方根
- 単位は目的変数と同じ
- 解釈しやすい

**解釈**:
- 小さいほど良い
- 0が最良
- 平均的な誤差の大きさ

#### 3. 平均絶対誤差（MAE: Mean Absolute Error）

**定義**:
```
MAE = (1/n) × Σ|yᵢ - ŷᵢ|
```

**特徴**:
- 誤差の絶対値を平均
- 外れ値に頑健
- 単位は目的変数と同じ

**解釈**:
- 小さいほど良い
- 0が最良
- 平均的な誤差の大きさ

### MSE vs MAE の比較

| 項目 | MSE | MAE |
|------|-----|-----|
| 外れ値への感度 | 高い | 低い |
| 大きな誤差 | 重視 | 等しく扱う |
| 単位 | 目的変数の二乗 | 目的変数と同じ |
| 解釈 | やや困難 | 容易 |

### 具体例：住宅価格予測

**データ例**:
| 実際の価格 | 予測価格 | 誤差 | 誤差² | |誤差| |
|-----------|----------|------|-------|-------|
| 3000万円 | 3200万円 | -200万円 | 40000 | 200万円 |
| 4000万円 | 3800万円 | 200万円 | 40000 | 200万円 |
| 5000万円 | 5200万円 | -200万円 | 40000 | 200万円 |

**計算**:
- MSE = (40000 + 40000 + 40000) / 3 = 40000
- RMSE = √40000 = 200万円
- MAE = (200 + 200 + 200) / 3 = 200万円

## 決定係数（R²）

### 基本概念

**決定係数（R²）**は、**モデルがデータの変動をどれだけ説明できるか**を表す指標です。

### 数学的定義

#### 1. 基本的な定義
```
R² = 1 - (SSE / SST)
```

ここで：
- **SSE**: 残差平方和 = Σ(yᵢ - ŷᵢ)²
- **SST**: 総平方和 = Σ(yᵢ - ȳ)²
- **ȳ**: 目的変数の平均値

#### 2. 相関係数の二乗
```
R² = r²
```

ここで：
- **r**: 実際の値と予測値の相関係数

### R²の解釈

#### 1. 値の範囲
- **0 ≤ R² ≤ 1**
- **R² = 1**: 完全な説明（理想的）
- **R² = 0**: 説明なし（平均値予測と同等）
- **R² < 0**: 平均値予測より悪い

#### 2. 実務的な解釈
- **R² > 0.8**: 非常に良い
- **R² > 0.6**: 良い
- **R² > 0.4**: 許容範囲
- **R² < 0.4**: 改善が必要

### R²の制約

#### 1. 特徴量数の影響
- 特徴量を増やすとR²は増加
- 必ずしも性能向上を意味しない

#### 2. 外れ値への感度
- 外れ値がR²に大きく影響
- 頑健性に欠ける

#### 3. 非線形関係
- 線形関係を前提
- 非線形関係では不適切

### 具体例：R²の計算

**データ例**:
| 実際の価格 | 予測価格 | 平均価格 |
|-----------|----------|----------|
| 3000万円 | 3200万円 | 4000万円 |
| 4000万円 | 3800万円 | 4000万円 |
| 5000万円 | 5200万円 | 4000万円 |

**計算**:
- ȳ = 4000万円
- SSE = (3000-3200)² + (4000-3800)² + (5000-5200)² = 120000
- SST = (3000-4000)² + (4000-4000)² + (5000-4000)² = 2000000
- R² = 1 - (120000 / 2000000) = 1 - 0.06 = 0.94

**解釈**: モデルは価格の変動の94%を説明している

## 調整済み決定係数

### 基本概念

**調整済み決定係数（R²adj）**は、**特徴量数を考慮した決定係数**です。

### 数学的定義

```
R²adj = 1 - (SSE / (n - p - 1)) / (SST / (n - 1))
```

ここで：
- **n**: サンプル数
- **p**: 特徴量数

### 調整済み決定係数の特徴

#### 1. 特徴量数のペナルティ
- 特徴量数が多いほど減少
- 過剰な特徴量を防ぐ

#### 2. 自由度の考慮
- 残差の自由度: n - p - 1
- 総平方和の自由度: n - 1

#### 3. 比較可能性
- 異なる特徴量数のモデルを比較可能
- 特徴選択の指標として有用

### R² vs R²adj の比較

| 項目 | R² | R²adj |
|------|----|----|
| 特徴量数の影響 | 増加する | ペナルティあり |
| 比較可能性 | 特徴量数が同じ場合のみ | 異なる特徴量数でも可能 |
| 解釈 | 説明力 | 効率的な説明力 |

### 具体例：調整済み決定係数の計算

**データ例**:
- サンプル数: n = 100
- 特徴量数: p = 5
- R² = 0.8

**計算**:
- R²adj = 1 - (1 - 0.8) × (100 - 1) / (100 - 5 - 1)
- R²adj = 1 - 0.2 × 99 / 94
- R²adj = 1 - 0.211 = 0.789

**解釈**: 特徴量数を考慮すると、実際の説明力は78.9%

## 指標の使い分け

### 指標選択の指針

#### 1. 問題の性質
- **予測精度重視**: RMSE, MAE
- **説明力重視**: R², R²adj
- **外れ値が多い**: MAE
- **外れ値が少ない**: RMSE

#### 2. ビジネス要件
- **解釈しやすさ**: MAE, R²
- **計算効率**: MSE, R²
- **比較可能性**: R²adj

#### 3. データの特性
- **データサイズ**: 小さい場合はR²adj
- **特徴量数**: 多い場合はR²adj
- **外れ値**: 多い場合はMAE

### 複数指標の併用

#### 1. 基本的な組み合わせ
```
RMSE + R²: 予測精度と説明力
MAE + R²adj: 頑健性と効率性
```

#### 2. 詳細な分析
```
MSE: 基本的な性能
RMSE: 解釈しやすい性能
MAE: 頑健な性能
R²: 説明力
R²adj: 効率的な説明力
```

### 指標の解釈

#### 1. 絶対的な解釈
- **RMSE**: 平均的な誤差の大きさ
- **MAE**: 平均的な誤差の大きさ
- **R²**: 説明できる変動の割合

#### 2. 相対的な解釈
- **ベースラインとの比較**: 平均値予測との比較
- **改善の確認**: 前回のモデルとの比較
- **目標との比較**: ビジネス要件との比較

## 実装の比較

### 手動計算 vs ライブラリ

#### 1. 手動計算
**利点**:
- 理解が深まる
- カスタマイズ可能
- 教育効果が高い

**欠点**:
- 実装が複雑
- エラーが起きやすい
- 時間がかかる

#### 2. ライブラリ使用
**利点**:
- 実装が簡単
- エラーが少ない
- 高速

**欠点**:
- 理解が浅い
- カスタマイズが困難
- 依存関係

### 実装の選択基準

| 項目 | 手動計算 | ライブラリ |
|------|----------|-----------|
| 学習目的 | 推奨 | 非推奨 |
| 実務目的 | 非推奨 | 推奨 |
| カスタマイズ | 容易 | 困難 |
| 保守性 | 低い | 高い |

### 実装時の注意点

#### 1. データの前処理
- 欠損値の処理
- 外れ値の検出
- 特徴量のスケーリング

#### 2. 計算の精度
- 浮動小数点の誤差
- 数値計算の安定性
- オーバーフローの回避

#### 3. 可視化の活用
- 残差プロット
- 予測値 vs 実際値
- 誤差の分布

## まとめ

### 評価指標の重要性

適切な評価指標の選択は、機械学習モデルの成功に不可欠です。問題の性質とビジネス要件を考慮して指標を選択しましょう。

### 主要な指標

- **MSE/RMSE**: 基本的な予測精度
- **MAE**: 頑健な予測精度
- **R²**: 説明力
- **R²adj**: 効率的な説明力

### 実践的なポイント

1. **複数指標の併用**: 様々な角度からの評価
2. **適切な解釈**: 指標の意味を正しく理解
3. **継続的な改善**: 評価結果に基づく改善
4. **ビジネス価値**: 実用的な価値との関連

### 次のステップ

- [非線形回帰](../06_nonlinear_regression/06_nonlinear_regression.md)
- [総まとめ](../07_summary/07_comprehensive_summary.md)

---

**関連ノートブック**:
- [回帰評価指標](./notebooks/regression_metrics.ipynb)
