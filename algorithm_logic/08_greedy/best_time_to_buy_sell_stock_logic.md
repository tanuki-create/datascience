# Best Time to Buy and Sell Stock - ロジック解説

## 問題概要

株価の配列が与えられたとき、1回の取引で得られる最大利益を求める。

**制約**:
- `1 <= prices.length <= 10^5`

**例**:
```
Input: prices = [7,1,5,3,6,4]
Output: 5
説明: 2日目に買い(1)、5日目に売り(6) → 利益5
```

## ロジックの核心

### なぜ貪欲法が有効か？

**全探索（O(n²)）**:
- 全ての買い/売りの組み合わせを試す
- 時間計算量: O(n²) - 非効率

**貪欲法を使う理由**:
- **局所最適選択**: 各時点で最安値で買い、最高値で売る
- **1回の走査**: 過去の最安値を追跡しながら、各時点での最大利益を計算
- **時間計算量**: O(n) - 線形時間で効率的

### 思考プロセス

1. **最安値の追跡**: これまでに見た最安値を保持
2. **利益の計算**: 各時点で売った場合の利益を計算
3. **最大利益の更新**: 計算した利益の最大値を更新

### アルゴリズムのステップ

```
1. min_price = prices[0], max_profit = 0 を初期化
2. i = 1 から n-1 まで:
   a. min_price = min(min_price, prices[i])
   b. profit = prices[i] - min_price
   c. max_profit = max(max_profit, profit)
3. max_profit を返す
```

## 具体例でのトレース

### 例: `prices = [7,1,5,3,6,4]`

| ステップ | i | prices[i] | min_price | profit | max_profit | 説明 |
|---------|---|-----------|-----------|--------|------------|------|
| 初期 | - | - | 7 | - | 0 | 最初の価格を最安値として設定 |
| 1 | 0 | 7 | 7 | - | 0 | 最初の日は買いのみ、利益は0 |
| 2 | 1 | 1 | 1 | - | 0 | 価格1が最安値に更新、まだ売るタイミングなし |
| 3 | 2 | 5 | 1 | 4 | 4 | 価格5で売ると利益4、最大利益を更新 |
| 4 | 3 | 3 | 1 | 2 | 4 | 価格3で売ると利益2、最大利益は4のまま |
| 5 | 4 | 6 | 1 | 5 | 5 | 価格6で売ると利益5、最大利益を更新 |
| 6 | 5 | 4 | 1 | 3 | 5 | 価格4で売ると利益3、最大利益は5のまま |

**結果**: `5` - 2日目（価格1）に買い、5日目（価格6）に売ると最大利益5

### 可視化

```
価格: [7, 1, 5, 3, 6, 4]
日:   0  1  2  3  4  5

最適な取引:
  買い: 日1（価格1）← これまでで最安値
  売り: 日4（価格6）← 買い時点以降で最高値
  利益: 6 - 1 = 5

他の選択肢:
  日0買い→日4売り: 6-7=-1（損失）
  日1買い→日2売り: 5-1=4（利益だが最大ではない）
  日1買い→日4売り: 6-1=5（最大利益）✓
```

## 現実世界での応用

### 1. 金融取引システム（アルゴリズム取引）
- **シナリオ**: リアルタイムで最適な売買タイミングを決定
- **実装**: 同様の貪欲法で最大利益を計算
- **例**: 高頻度取引（HFT）システムで、ミリ秒単位で最適な売買タイミングを決定
- **メリット**: リアルタイムで意思決定し、利益を最大化

### 2. 在庫管理システム
- **シナリオ**: 商品の価格変動から最適な購入/販売タイミングを決定
- **実装**: 価格データから最大利益を計算
- **例**: 小売業で、仕入れ価格と販売価格の変動から最適な在庫管理戦略を決定
- **メリット**: 在庫コストを最小化しながら利益を最大化

### 3. エネルギー取引
- **シナリオ**: 電力やガスの価格変動から最適な購入/販売タイミングを決定
- **実装**: 時系列価格データから最大利益を計算
- **例**: 電力会社が、電力市場での最適な購入/販売タイミングを決定
- **メリット**: エネルギーコストを最適化

### 4. 為替取引
- **シナリオ**: 通貨の為替レート変動から最適な売買タイミングを決定
- **実装**: 為替レートの時系列データから最大利益を計算
- **例**: 外貨預金やFX取引で、最適な売買タイミングを決定
- **メリット**: 為替差益を最大化

### 5. 不動産投資
- **シナリオ**: 不動産価格の変動から最適な購入/販売タイミングを決定
- **実装**: 不動産価格の時系列データから最大利益を計算
- **例**: 不動産投資で、価格が最も低い時に購入し、最も高い時に売却
- **メリット**: 投資リターンを最大化

## 注意点と落とし穴

### 1. 買いが売りより後である必要がある
- **問題**: 必ず買ってから売る必要がある（時系列の制約）
- **解決策**: 過去の最安値を追跡し、現在の価格で売った場合の利益を計算
- **注意**: 未来の価格を見ることはできない（実際の取引では予測が必要）

### 2. 利益が負の場合の処理
- **問題**: 価格が単調減少する場合、利益が出ない
- **解決策**: 利益が出ない場合は0を返す（取引を行わない）
- **実装**: `max_profit = max(max_profit, profit)`で、負の利益は0より小さいため自動的に0が返される

### 3. 単調減少する価格の処理
- **問題**: 価格が常に下がり続ける場合、最適な戦略は取引を行わないこと
- **解決策**: アルゴリズムは自動的に0を返す
- **例**: `prices = [7,6,5,4,3]`の場合、どの時点でも損失になるため、取引を行わない

### 4. 最安値の更新タイミング
- **問題**: 最安値を更新するタイミングが重要
- **解決策**: 各時点で最安値を更新してから、利益を計算する
- **注意**: 最安値を更新した時点では、まだ売るタイミングが最適とは限らない

### 5. 複数回の取引が可能な場合
- **問題**: この問題は1回の取引のみを許可
- **拡張**: 複数回の取引が可能な場合は、貪欲的に全ての上昇局面で取引する（Best Time to Buy and Sell Stock II）
- **違い**: 1回の取引では最適な買いと売りの1組を探すが、複数回の取引では全ての利益機会を捉える

### 6. 取引コストの考慮
- **問題**: 実際の取引では手数料やスプレッドが発生する
- **解決策**: 利益計算時に取引コストを差し引く必要がある
- **実装**: `profit = price - min_price - transaction_cost`

## 関連問題

- Best Time to Buy and Sell Stock II（複数回取引可能）
- Best Time to Buy and Sell Stock III（最大2回取引）

---

**次のステップ**: [Maximum Subarray](./maximum_subarray_logic.md)でKadane's Algorithmを学ぶ

