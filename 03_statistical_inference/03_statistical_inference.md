# 統計的推論

## 目次
1. [統計的推論とは](#統計的推論とは)
2. [係数の仮説検定](#係数の仮説検定)
3. [モデル全体の検定](#モデル全体の検定)
4. [ダミー変数とカテゴリ変数](#ダミー変数とカテゴリ変数)
5. [信頼区間](#信頼区間)
6. [実装の比較](#実装の比較)
7. [まとめ](#まとめ)

## 統計的推論とは

### 定義
統計的推論（Statistical Inference）は、**サンプルデータから母集団の特性について統計的に結論を導く**手法です。線形回帰においては、回帰係数の統計的有意性や信頼性を評価するために使用されます。

### 統計的推論の目的

1. **係数の有意性検定**: 各説明変数が目的変数に統計的に有意な影響を与えるかを判定
2. **モデル全体の検定**: 回帰モデル全体が統計的に有意かを判定
3. **信頼区間の構築**: 係数の真の値が含まれる可能性の高い範囲を推定
4. **予測の信頼性**: 予測値の不確実性を定量化

### 基本概念

#### 帰無仮説と対立仮説
- **帰無仮説（H₀）**: 係数が0である（影響がない）
- **対立仮説（H₁）**: 係数が0でない（影響がある）

#### 有意水準
- **α = 0.05**: 5%の確率で第一種の過誤を犯すことを許容
- **α = 0.01**: 1%の確率で第一種の過誤を犯すことを許容

#### p値
- **p < α**: 帰無仮説を棄却（統計的に有意）
- **p ≥ α**: 帰無仮説を採択（統計的に有意でない）

## 係数の仮説検定

### t検定の基本概念

回帰係数の統計的有意性を検定するために、**t検定**を使用します。

### 数学的表現

#### t統計量の計算
```
t = β̂ⱼ / SE(β̂ⱼ)
```

ここで：
- `β̂ⱼ`: j番目の回帰係数の推定値
- `SE(β̂ⱼ)`: 係数の標準誤差

#### 標準誤差の計算
```
SE(β̂ⱼ) = √(σ² × (XᵀX)⁻¹ⱼⱼ)
```

ここで：
- `σ²`: 誤差分散の推定値
- `(XᵀX)⁻¹ⱼⱼ`: 設計行列の逆行列のj番目の対角要素

#### 誤差分散の推定
```
σ² = SSE / (n - p - 1) = Σ(yᵢ - ŷᵢ)² / (n - p - 1)
```

ここで：
- `SSE`: 残差平方和
- `n`: サンプル数
- `p`: 説明変数の数

### 自由度の計算

t分布の自由度は：
```
df = n - p - 1
```

### 具体例：住宅価格予測

**問題設定**: 面積と築年数から価格を予測するモデル
```
価格 = β₀ + β₁ × 面積 + β₂ × 築年数 + ε
```

**検定の設定**:
- H₀: β₁ = 0（面積は価格に影響しない）
- H₁: β₁ ≠ 0（面積は価格に影響する）

**結果の解釈**:
- t統計量 = 3.45
- 自由度 = 97
- p値 = 0.001
- 結論: p < 0.05なので、面積は統計的に有意

### t検定の前提条件

1. **正規性**: 誤差項が正規分布に従う
2. **等分散性**: 誤差項の分散が一定
3. **独立性**: 観測値が互いに独立
4. **線形性**: 説明変数と目的変数の関係が線形

## モデル全体の検定

### F検定の基本概念

**F検定**は、回帰モデル全体の統計的有意性を検定する手法です。

### 数学的表現

#### F統計量の計算
```
F = (SSR / p) / (SSE / (n - p - 1))
```

ここで：
- `SSR`: 回帰平方和
- `SSE`: 残差平方和
- `p`: 説明変数の数
- `n`: サンプル数

#### 平方和の分解
```
SST = SSR + SSE
```

ここで：
- `SST`: 総平方和
- `SSR`: 回帰平方和（モデルで説明される変動）
- `SSE`: 残差平方和（モデルで説明されない変動）

### 決定係数（R²）

```
R² = SSR / SST = 1 - (SSE / SST)
```

- **0 ≤ R² ≤ 1**: モデルがデータを説明する割合
- **R² = 1**: 完全な説明（理想的）
- **R² = 0**: 説明なし（切片のみのモデルと同等）

### 調整済み決定係数（R²adj）

```
R²adj = 1 - (SSE / (n - p - 1)) / (SST / (n - 1))
```

- 説明変数の数を考慮した決定係数
- 過剰な変数追加を防ぐ指標

### 具体例：モデル全体の検定

**問題設定**: 3つの説明変数を持つ重回帰モデル
```
価格 = β₀ + β₁ × 面積 + β₂ × 築年数 + β₃ × 立地 + ε
```

**F検定の結果**:
- F統計量 = 45.2
- 自由度 = (3, 96)
- p値 < 0.001
- 結論: モデル全体が統計的に有意

## ダミー変数とカテゴリ変数

### カテゴリ変数の処理

#### one-hotエンコーディング

カテゴリ変数を数値化する手法です。

**例：立地のカテゴリ**
- 元のデータ: ['都心', '郊外', '都心', '郊外']
- one-hotエンコーディング後:

| 都心 | 郊外 |
|------|------|
| 1    | 0    |
| 0    | 1    |
| 1    | 0    |
| 0    | 1    |

#### ダミー変数トラップの回避

**問題**: 完全な多重共線性
- すべてのダミー変数を含めると、合計が常に1になる
- 行列が正則でなくなり、逆行列が計算できない

**解決策**: 参照カテゴリを除外
- 1つのカテゴリを基準として除外
- 除外されたカテゴリが参照カテゴリとなる

### ダミー変数の解釈

#### 係数の意味

```
価格 = β₀ + β₁ × 面積 + β₂ × 都心ダミー + ε
```

- `β₀`: 郊外の基準価格（参照カテゴリ）
- `β₂`: 都心の価格差（都心 - 郊外）

#### 具体例

**回帰結果**:
- β₀ = 2000万円（郊外の基準価格）
- β₁ = 50万円/m²（面積の係数）
- β₂ = 500万円（都心の価格差）

**解釈**:
- 郊外の住宅: 価格 = 2000 + 50 × 面積
- 都心の住宅: 価格 = 2500 + 50 × 面積

### 多カテゴリ変数の処理

#### 3つ以上のカテゴリの場合

**例：立地（都心、郊外、田舎）**

| 都心 | 郊外 | 田舎 |
|------|------|------|
| 1    | 0    | 0    |
| 0    | 1    | 0    |
| 0    | 0    | 1    |

**参照カテゴリ**: 田舎（除外）
**解釈**: 都心と郊外の田舎に対する価格差

## 信頼区間

### 信頼区間の基本概念

**信頼区間**は、係数の真の値が含まれる可能性の高い範囲を推定します。

### 数学的表現

#### 係数の信頼区間

```
β̂ⱼ ± t_{α/2, df} × SE(β̂ⱼ)
```

ここで：
- `t_{α/2, df}`: 自由度dfのt分布のα/2パーセンタイル
- `SE(β̂ⱼ)`: 係数の標準誤差

#### 予測値の信頼区間

**平均応答の信頼区間**:
```
ŷ ± t_{α/2, df} × SE(ŷ)
```

**個別予測の信頼区間**:
```
ŷ ± t_{α/2, df} × SE(ŷ + ε)
```

### 信頼区間の解釈

#### 95%信頼区間の意味
- 同じ手順で100回サンプリングした場合
- 95回は真の値が信頼区間に含まれる
- 5回は真の値が信頼区間外になる

#### 信頼区間の幅に影響する要因

1. **サンプルサイズ**: 大きいほど狭くなる
2. **変動性**: 小さいほど狭くなる
3. **信頼水準**: 高いほど広くなる
4. **説明変数の値**: 平均に近いほど狭くなる

### 具体例：信頼区間の計算

**回帰結果**:
- β̂₁ = 50万円/m²
- SE(β̂₁) = 5万円/m²
- 自由度 = 97
- t_{0.025, 97} = 1.98

**95%信頼区間**:
```
50 ± 1.98 × 5 = 50 ± 9.9
```
**区間**: [40.1, 59.9]万円/m²

**解釈**: 面積の係数の真の値は、95%の確率で40.1〜59.9万円/m²の範囲に含まれる

## 実装の比較

### 統計的推論の実装方法

#### 1. 手動計算
- 数学的公式を直接実装
- 理解が深まる
- 計算量が多い

#### 2. 統計ライブラリの活用
- scipy.stats
- statsmodels
- 計算が高速
- 実装が簡単

#### 3. 機械学習ライブラリ
- scikit-learn
- 基本的な統計量のみ
- 詳細な統計的推論には不十分

### 実装時の注意点

#### 1. 前提条件の確認
- 正規性の検定（Shapiro-Wilk検定）
- 等分散性の検定（Breusch-Pagan検定）
- 独立性の確認

#### 2. 多重比較の調整
- 複数の検定を行う場合
- Bonferroni補正
- False Discovery Rate (FDR)

#### 3. 外れ値の影響
- 外れ値が統計的推論に与える影響
- ロバスト統計手法の検討

### 実装の選択基準

| 項目 | 手動計算 | 統計ライブラリ | 機械学習ライブラリ |
|------|----------|----------------|-------------------|
| 理解度 | 高い | 中程度 | 低い |
| 実装時間 | 長い | 短い | 最短 |
| 柔軟性 | 高い | 中程度 | 低い |
| 計算精度 | 中程度 | 高い | 中程度 |
| 保守性 | 低い | 高い | 高い |

## まとめ

### 統計的推論の重要性

統計的推論は、線形回帰モデルの信頼性を評価するために不可欠です。単なる予測だけでなく、変数間の関係の統計的有意性を確認することで、より説得力のある分析が可能になります。

### 主要な手法

- **t検定**: 個別係数の有意性検定
- **F検定**: モデル全体の有意性検定
- **信頼区間**: 係数の不確実性の定量化
- **ダミー変数**: カテゴリ変数の適切な処理

### 実践的なポイント

1. **前提条件の確認**: 正規性、等分散性、独立性
2. **適切な解釈**: p値の正しい理解
3. **多重比較**: 複数検定時の調整
4. **実務的な判断**: 統計的有意性と実用的有意性の区別

### 次のステップ

- [モデル評価](../04_model_evaluation/04_model_evaluation.md)
- [評価指標](../05_metrics/05_evaluation_metrics.md)
- [非線形回帰](../06_nonlinear_regression/06_nonlinear_regression.md)

---

**関連ノートブック**:
- [係数のt検定](./notebooks/coefficient_t_test.ipynb)
- [ダミー変数](./notebooks/dummy_variables.ipynb)